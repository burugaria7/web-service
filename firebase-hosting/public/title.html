<!DOCTYPE html>
<html>

<body>
    <a href="index.html">auth</a>
    <a href="games/tictactoe.html">Tictactoe</a>
    <a href="games/minesweeper.html">Minesweeper</a><br>
    <input type="button" id="button1" onclick="matching()" value="マッチング"><br>
    <input type="button" id="button2" onclick="cansel()" value="キャンセル" disabled><br>
    <div id="name_1"></div>
    <div id="name_2"></div>

<!--    <h1>...Please wait</h1>-->
<!--    <div id="info"></div>-->

    <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-app.js"></script>
    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-analytics.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-firestore.js"></script>
    <script src="./config.js"></script>
    <script>
        // TODO: Replace the following with your app's Firebase project configuration
        // For Firebase JavaScript SDK v7.20.0 and later, `measurementId` is an optional field
        var config = {
            apiKey: "AIzaSyBd0lVP2y9PXw8A0xQCc7C-t7UWgPdk7kY",
            authDomain: "recess-web.firebaseapp.com",
            databaseURL: "https://recess-web-default-rtdb.firebaseio.com/",
            projectId: "recess-web",
            storageBucket: "gs://recess-web.appspot.com"
        };
        firebase.initializeApp(config);
    </script>

<!--    <script>-->
<!--        firebase.auth().onAuthStateChanged((user) => {-->
<!--            let h1 = document.querySelector('h1');-->
<!--            let info = document.querySelector('#info');-->

<!--            if (user) {-->
<!--                h1.innerText = 'Login Complete!';-->
<!--                info.innerHTML = `${user.displayName}さんがログインしました`;-->
<!--            } else {-->
<!--                h1.innerText = 'Not Login';-->
<!--            }-->
<!--        });-->
<!--    </script>-->

    <script>
        var db = firebase.firestore();

        var user;
        let room_id = null;
        let find = null;
        const gameref = db.collection("rooms").doc("tictactoe");
        const rankref = gameref.collection("rank");

        firebase.auth().onAuthStateChanged((userinfo) => {
          if (userinfo) {
            user = userinfo;
            console.log("login");
            console.log(user.displayName);
          } else {
              console.log("not login");
          }
        });

        function cansel(){
            console.log("cansel");
            room_id = null;
            if (document.getElementById("button1").disabled){
                document.getElementById("button1").disabled = false;
                document.getElementById("button2").disabled = true;
            }
            else{
                document.getElementById("button2").disabled = false;
            }
        }

        async function matching() {
            find = false;
            document.getElementById("button1").disabled = true;
            document.getElementById("button2").disabled = false;
            try{
                console.log("matching");
                await check_room();
                if (find){
                    await enter_room();
                    await fight();
                }
                else{
                    create_room();
                }
            }catch (e) {
                console.log("matching error");
            }
        }

        function create_room() {
            console.log("create");
            rankref.add({ now_people : 1})
                .then(function(docRef) {
                    room_id = docRef.id
                    rankref.doc(room_id).
                    set({ player_1 : user.displayName }, { merge: true });
                });
        }

        async function enter_room() {
            console.log("enter");
            var roomref = rankref.doc(room_id)
            let now = await get_nowpeople();
            console.log("now");
            console.log(now);
            await roomref.update({
               now_people : now + 1
            })
            .then(function() {
                roomref.set({ "player_2" : user.displayName }, { merge: true });
            })
        }

        async function get_nowpeople() {
            let querySnapshot = await rankref.doc(room_id).get();
            var now = querySnapshot.data().now_people;
            console.log("value");
            console.log(now);
            return now;
        }

        async function check_room() {
            console.log("check");
            try{
                await rankref.where("now_people", "==", 1)
                .get().then(function(querySnapshot) {
                    // console.log("test1");
                    for(let i = 0 ; i < querySnapshot.size ; i++) {
                        var childKey = querySnapshot.docs[i].id;
                        var childData = querySnapshot.docs[i].data().now_people;
                        // console.log(childKey);
                        // console.log(childData);
                        if (childData === 1){
                            // console.log("in");
                            room_id = childKey;
                            find = true;
                            return;
                        }
                    }
                });
            }catch (e) {
                console.log("error");
            }
        }

        async function fight() {
            console.log("fight");
            var player1;
            var player2;
            await rankref.doc(room_id)
            .get().then(function(querySnapshot) {
                player1 = querySnapshot.data().player_1;
                player2 = querySnapshot.data().player_2;
                });
            document.getElementById("name_1").innerHTML = player1;
            document.getElementById("name_2").innerHTML = player2;
        }
    </script>

</body>


</html>